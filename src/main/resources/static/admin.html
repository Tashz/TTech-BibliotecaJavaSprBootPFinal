<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Gesti√≥n - Biblioteca</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; background: #f4f6f8; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: #2c3e50; color: white; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .sidebar h2 { margin-top: 0; border-bottom: 1px solid #4b6584; padding-bottom: 15px; font-size: 1.4rem; }
        .menu-item { padding: 12px; color: #bdc3c7; text-decoration: none; cursor: pointer; border-radius: 6px; margin-bottom: 5px; transition: 0.2s; display: block; }
        .menu-item:hover, .menu-item.active { background: #34495e; color: white; font-weight: bold; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .panel { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: none; }
        .panel.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        label { font-weight: 600; font-size: 0.9rem; display: block; margin-bottom: 5px; color: #444; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 600; }
        .btn-green { background: #27ae60; } .btn-blue { background: #3498db; } .btn-red { background: #e74c3c; } .btn-orange { background: #f39c12; } .btn-purple { background: #8e44ad; }
        .pos-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .ticket-preview { background: #fafafa; border: 2px dashed #ccc; padding: 15px; }

        /* Modal Styles */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #modal-box { background: white; padding: 25px; border-radius: 8px; width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; }
        #modal-msg { margin-bottom: 20px; font-size: 1.1rem; color: #333; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: #3498db; color: white; }
    </style>
</head>
<body>
<div id="modal-overlay"><div id="modal-box"><h3 id="modal-title">Aviso</h3><p id="modal-msg"></p><button class="modal-btn" onclick="cerrarModal()">Aceptar</button></div></div>

<div class="sidebar">
    <h2>üìö Admin Panel</h2>
    <a class="menu-item active" onclick="mostrar('inventario')">üì¶ Inventario</a>
    <a class="menu-item" onclick="mostrar('pos')">üñ•Ô∏è Terminal POS</a>
    <a class="menu-item" onclick="mostrar('pedidos')">üìÑ Pr√©stamos y Ventas</a>
    <div style="flex-grow:1"></div>
    <a href="index.html" class="menu-item" style="background:#f1c40f; color:#333;">‚¨ÖÔ∏è Ver Cat√°logo P√∫blico</a>
</div>

<div class="main-content">
    <div id="inventario" class="panel active">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>üì¶ Gesti√≥n de Inventario</h3>
            <button class="btn btn-green" onclick="limpiarFormulario()">+ Nuevo Libro</button>
        </div>
        <div style="background:#f9f9f9; padding:15px; border-radius:6px; margin-bottom:20px; border:1px solid #eee;">
            <input type="hidden" id="libro-id">
            <div style="display:flex; gap:10px;"><div style="flex:2;"><label>T√≠tulo</label><input id="titulo"></div><div style="flex:1;"><label>Autor</label><input id="autor"></div></div>
            <div style="display:flex; gap:10px;"><div style="flex:1;"><label>Stock</label><input type="number" id="stock"></div><div style="flex:1;"><label>Precio Venta</label><input type="number" id="p-venta"></div><div style="flex:1;"><label>Costo Alquiler</label><input type="number" id="p-alquiler"></div></div>
            <div style="display:flex; gap:10px;"><div style="flex:3;"><label>Imagen URL</label><input id="imagen"></div><div style="flex:1;"><label>Categor√≠a</label><input id="categoria"></div></div>
            <button class="btn btn-blue" onclick="guardarLibro()">üíæ Guardar</button> <button class="btn btn-red" onclick="limpiarFormulario()" style="background:#95a5a6;">Limpiar</button>
        </div>
        <table><thead><tr><th>ID</th><th>T√≠tulo</th><th>Stock</th><th>$ Venta</th><th>$ Alquiler</th><th>Acciones</th></tr></thead><tbody id="tabla-libros"></tbody></table>
    </div>

    <div id="pos" class="panel">
        <h3>üñ•Ô∏è Terminal de Mostrador</h3>
        <div class="pos-grid">
            <div>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #bbdefb;">
                    <h4 style="margin:0 0 10px 0; color:#1565c0;">üë§ Datos del Cliente</h4>
                    <div style="display:flex; gap:10px;"><div style="flex:1;"><label>DNI *</label><input id="cli-dni"></div><div style="flex:1;"><label>Nombre *</label><input id="cli-nombre"></div><div style="flex:1;"><label>Apellido *</label><input id="cli-apellido"></div></div>
                    <div style="display:flex; gap:10px;"><div style="flex:1;"><label>Tel√©fono</label><input id="cli-tel"></div><div style="flex:1;"><label>Email</label><input id="cli-email"></div></div>
                </div>
                <label>Buscar Libro</label><input list="lista-libros-pos" id="pos-libro-input" placeholder="Escribe t√≠tulo o ID..."><datalist id="lista-libros-pos"></datalist>
                <div style="display:flex; gap:10px; align-items:flex-end; margin-top:10px;">
                    <div style="flex:1;"><label>Cantidad</label><input type="number" id="pos-cantidad" value="1" min="1"></div>
                    <div style="flex:1;"><label>Tipo</label><select id="pos-tipo"><option value="ALQUILER">üìñ Pr√©stamo</option><option value="VENTA">üè∑Ô∏è Venta</option></select></div>
                    <button class="btn btn-green" style="height:42px;" onclick="agregarAlTicket()">+ Agregar</button>
                </div>
            </div>
            <div class="ticket-preview"><h4 style="margin-top:0; text-align:center;">Ticket</h4><div id="pos-items" style="min-height:150px;"></div><hr><h3 style="text-align:right;">Total: $<span id="pos-total">0.00</span></h3><button class="btn btn-blue" style="width:100%;" onclick="confirmarOrdenPOS()">‚úÖ Confirmar</button></div>
        </div>
    </div>

    <div id="pedidos" class="panel">
        <h3>üìÑ Historial de Operaciones</h3>
        <button class="btn btn-orange" onclick="cargarPedidos()">üîÑ Actualizar Tabla</button>
        <table><thead><tr><th>#</th><th>Cliente</th><th>Fecha</th><th>Detalle</th><th>Total</th><th>Estado / Acci√≥n</th></tr></thead><tbody id="tabla-pedidos"></tbody></table>
    </div>
</div>

<script>
    const API = 'http://localhost:8080/api';
    let carritoPOS = [], librosCache = [];

    document.addEventListener("DOMContentLoaded", () => { cargarInventario(); });

    // MODAL
    function mostrarModal(msg, err = false) {
        document.getElementById('modal-msg').innerText = msg;
        document.getElementById('modal-title').innerText = err ? "‚ùå Error" : "‚úÖ √âxito";
        document.getElementById('modal-title').style.color = err ? "#e74c3c" : "#27ae60";
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function cerrarModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    function mostrar(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'pedidos') cargarPedidos();
        if(id === 'pos') llenarDataList();
    }

    // INVENTARIO
    async function cargarInventario() {
        const res = await fetch(`${API}/libros`);
        librosCache = await res.json();
        const tbody = document.getElementById('tabla-libros'); tbody.innerHTML = '';
        librosCache.forEach(l => {
            tbody.innerHTML += `<tr><td>${l.id}</td><td>${l.titulo}</td><td style="color:${l.stock<5?'red':'green'}"><b>${l.stock}</b></td><td>$${l.precioVenta}</td><td>$${l.costoAlquiler}</td><td><button class="btn btn-blue" onclick='editarLibro(${JSON.stringify(l)})'>‚úèÔ∏è</button> <button class="btn btn-red" onclick="borrarLibro(${l.id})">üóëÔ∏è</button></td></tr>`;
        });
        llenarDataList();
    }

    function llenarDataList() {
        const dl = document.getElementById('lista-libros-pos'); dl.innerHTML = '';
        librosCache.forEach(l => dl.innerHTML += `<option value="[ID: ${l.id}] ${l.titulo} (Stock: ${l.stock})">`);
    }

    async function guardarLibro() {
        const id = document.getElementById('libro-id').value;
        const datos = { titulo: document.getElementById('titulo').value, autor: document.getElementById('autor').value, stock: parseInt(document.getElementById('stock').value), precioVenta: parseFloat(document.getElementById('p-venta').value), costoAlquiler: parseFloat(document.getElementById('p-alquiler').value), imagenUrl: document.getElementById('imagen').value, categoria: document.getElementById('categoria').value };
        const res = await fetch(id ? `${API}/libros/${id}` : `${API}/libros`, { method: id ? 'PUT' : 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(datos) });
        if(res.ok) { mostrarModal("Guardado"); limpiarFormulario(); cargarInventario(); } else mostrarModal("Error", true);
    }
    function limpiarFormulario() { document.getElementById('libro-id').value=''; document.querySelectorAll('#inventario input').forEach(i=>i.value=''); }
    function editarLibro(l) { document.getElementById('libro-id').value=l.id; document.getElementById('titulo').value=l.titulo; document.getElementById('autor').value=l.autor; document.getElementById('stock').value=l.stock; document.getElementById('p-venta').value=l.precioVenta; document.getElementById('p-alquiler').value=l.costoAlquiler; document.getElementById('imagen').value=l.imagenUrl; document.getElementById('categoria').value=l.categoria; window.scrollTo(0,0); }
    async function borrarLibro(id) { if(confirm("¬øSeguro?")) { await fetch(`${API}/libros/${id}`, {method:'DELETE'}); cargarInventario(); } }

    // POS
    function agregarAlTicket() {
        const val = document.getElementById('pos-libro-input').value;
        const match = val.match(/^\[ID: (\d+)\]/);
        if(!match) return mostrarModal("Selecciona un libro de la lista", true);
        const l = librosCache.find(x => x.id == match[1]);
        const cant = parseInt(document.getElementById('pos-cantidad').value);
        const tipo = document.getElementById('pos-tipo').value;
        if(tipo === 'VENTA' && (l.stock - cant) < 5) mostrarModal("‚ö†Ô∏è Advertencia: Quedan < 5 libros", true);
        carritoPOS.push({ libroId: l.id, titulo: l.titulo, cantidad: cant, tipo: tipo, precio: tipo==='VENTA'?l.precioVenta:l.costoAlquiler });
        actualizarTicket();
        document.getElementById('pos-libro-input').value = '';
    }
    function actualizarTicket() {
        const d = document.getElementById('pos-items'); d.innerHTML = ''; let t = 0;
        carritoPOS.forEach((i,x) => { t+=i.precio*i.cantidad; d.innerHTML+=`<div style="border-bottom:1px dashed #ccc;padding:5px;">${i.cantidad}x ${i.titulo} (${i.tipo}) <span style="color:red;cursor:pointer;float:right;" onclick="carritoPOS.splice(${x},1);actualizarTicket()">[X]</span></div>`; });
        document.getElementById('pos-total').innerText = t.toFixed(2);
    }
    async function confirmarOrdenPOS() {
        if(carritoPOS.length===0) return mostrarModal("Ticket vac√≠o", true);
        const cli = { dni: document.getElementById('cli-dni').value, nombre: document.getElementById('cli-nombre').value, apellido: document.getElementById('cli-apellido').value, telefono: document.getElementById('cli-tel').value, email: document.getElementById('cli-email').value };
        if(!cli.dni || !cli.nombre || !cli.apellido) return mostrarModal("Datos de cliente obligatorios", true);

        const res = await fetch(`${API}/pedidos`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ clienteMostrador: cli, items: carritoPOS }) });
        if(res.ok) { mostrarModal("‚úÖ Operaci√≥n Exitosa"); carritoPOS=[]; actualizarTicket(); cargarInventario(); document.querySelectorAll('#pos input').forEach(i=>i.value=''); }
        else { const e = await res.json(); mostrarModal("Error: " + e.mensaje, true); }
    }

    // PEDIDOS Y DEVOLUCION
    async function cargarPedidos() {
        const res = await fetch(`${API}/pedidos`);
        const pedidos = await res.json();
        const tbody = document.getElementById('tabla-pedidos'); tbody.innerHTML = '';
        pedidos.forEach(p => {
            const det = p.detalles.map(d=>`${d.cantidad}x ${d.libro.titulo} (${d.tipo})`).join('<br>');
            let accion = `<span style="padding:4px 8px;border-radius:12px;color:white;background:${p.estado==='EN CURSO'?'#f39c12':'#27ae60'}">${p.estado}</span>`;

            // Si est√° en curso, mostramos bot√≥n para completar (Devolver libros)
            if(p.estado === 'EN CURSO') {
                accion += `<br><button class="btn btn-purple" style="margin-top:5px;font-size:0.7rem;" onclick="finalizarPedido(${p.id})">üìö Devolver</button>`;
            }

            tbody.innerHTML += `<tr><td>${p.id}</td><td>${p.usuario.nombre} ${p.usuario.apellido}<br><small>${p.usuario.dni||'Web'}</small></td><td>${new Date(p.fecha).toLocaleDateString()}</td><td style="font-size:0.8rem">${det}</td><td>$${p.total}</td><td>${accion}</td></tr>`;
        });
    }

    async function finalizarPedido(id) {
        if(!confirm("¬øConfirmar devoluci√≥n de libros y finalizar pr√©stamo?")) return;
        const res = await fetch(`${API}/pedidos/${id}/finalizar`, { method: 'PUT' });
        if(res.ok) { mostrarModal("Pr√©stamo finalizado y stock repuesto."); cargarPedidos(); }
        else mostrarModal("Error al finalizar", true);
    }
</script>
</body>
</html>